# Поведение соединения и переключение вкладок

## Почему connect может прерваться?

### Причины разрыва WebSocket соединения:

1. **Остановка сервера**
   - Если backend сервер остановлен или перезапускается
   - WebSocket закрывается с кодом 1006 (abnormal closure)

2. **Потеря сетевого соединения**
   - Проблемы с интернетом
   - Отключение WiFi/сети
   - Таймауты сети

3. **Таймаут бездействия**
   - Если сервер имеет таймаут для неактивных соединений
   - Chrome может закрыть неактивные соединения

4. **Ошибки на сервере**
   - Сервер может закрыть соединение при ошибке
   - Проблемы с обработкой сообщений

### Что происходит при разрыве:

1. **Offscreen document** обнаруживает закрытие WebSocket
2. Отправляет `WS_STATUS: 'disconnected'` в service worker
3. **Service worker** обновляет статус на `'idle'`
4. Уведомляет popup об изменении статуса
5. **Popup** должен показать кнопку "Connect" (теперь исправлено)

### Автоматическое переподключение:

Теперь добавлено автоматическое переподключение:
- При разрыве соединения (не нормальное закрытие)
- Через 3 секунды после разрыва
- Только если соединение не было закрыто вручную

---

## Что происходит при переходе на другую вкладку?

### WebSocket соединение:

✅ **НЕ прерывается** при переходе на другую вкладку
- Offscreen document работает независимо от вкладок
- WebSocket соединение поддерживается в фоне
- Переключение вкладок не влияет на соединение

### Захват аудио:

⚠️ **Зависит от того, какая вкладка была захвачена**

1. **Если запись уже начата:**
   - Захват продолжается с той вкладки, которая была активна при старте
   - Переход на другую вкладку НЕ останавливает захват
   - Аудио продолжает захватываться с исходной вкладки

2. **Если запись еще не начата:**
   - При нажатии "Start Recording" захватывается **текущая активная вкладка**
   - Если вы переключились на другую вкладку перед стартом, захватится новая вкладка

### Примеры:

**Сценарий 1:**
1. Вкладка A активна
2. Нажимаете "Start Recording"
3. Переключаетесь на вкладку B
4. ✅ Захват продолжается с вкладки A

**Сценарий 2:**
1. Вкладка A активна
2. Переключаетесь на вкладку B
3. Нажимаете "Start Recording"
4. ✅ Захватывается вкладка B

---

## Исправления в коде

### 1. Проверка состояния перед START_RECORDING

Теперь перед началом записи проверяется:
- ✅ Статус должен быть `'connected'`
- ✅ WebSocket должен быть открыт
- ✅ Если не подключено, показывается ошибка: "Not connected to server. Please connect first."

### 2. Правильная обработка статусов

- При разрыве соединения статус меняется на `'idle'`
- Если была активна запись, она останавливается
- Popup показывает кнопку "Connect" при статусе `'idle'` или `'error'`

### 3. Автоматическое переподключение

- При разрыве соединения (не нормальное закрытие)
- Автоматическая попытка переподключения через 3 секунды
- Не переподключается, если соединение закрыто вручную (DISCONNECT)

### 4. Верификация статуса

- При запросе статуса проверяется реальное состояние WebSocket
- Если статус не совпадает с реальным состоянием, он исправляется

---

## Рекомендации

### Для пользователя:

1. **Если соединение прервалось:**
   - Нажмите "Connect to Server" для переподключения
   - Или дождитесь автоматического переподключения (3 секунды)

2. **При переключении вкладок:**
   - Если запись уже идет, она продолжается с исходной вкладки
   - Чтобы захватить другую вкладку, остановите запись и начните заново

### Для разработчика:

1. **Мониторинг соединения:**
   - Логи в консоли offscreen document показывают состояние WebSocket
   - Service worker логирует изменения статуса

2. **Тестирование:**
   - Остановите backend сервер - должно произойти переподключение
   - Переключите вкладки во время записи - запись должна продолжаться
   - Закройте popup во время записи - запись должна продолжаться

