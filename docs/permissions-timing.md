# Когда браузер запрашивает разрешения для tabCapture

## Текущая ситуация

В вашем `manifest.json` уже есть разрешение:
```json
"permissions": ["tabCapture", "activeTab", "offscreen", "alarms"]
```

## Когда браузер запрашивает разрешения

### 1. При установке расширения (первый раз)

**Момент:** Когда пользователь устанавливает расширение из Chrome Web Store или загружает в режиме разработчика

**Что показывается:**
- Chrome показывает диалог с разрешениями расширения
- Пользователь видит: "Захват содержимого вкладок" (tabCapture)
- Пользователь должен нажать "Добавить расширение" или "Установить"

**Важно:** Это происходит **ОДИН РАЗ** при установке. После этого разрешение сохраняется.

### 2. При первом использовании (если разрешения нет в manifest)

**Если бы** в manifest не было `"tabCapture"`, то:
- Браузер запросил бы разрешение при первом вызове `chrome.tabCapture.getMediaStreamId()`
- Показался бы диалог: "Разрешить расширению захватывать содержимое вкладок?"

**Но у вас:** Разрешение уже есть в manifest, поэтому этого не произойдет.

### 3. getUserMedia() - системный диалог микрофона

**Момент:** Когда вызывается `navigator.mediaDevices.getUserMedia()` в offscreen document

**Что показывается:**
- **МОЖЕТ** показаться системный диалог разрешения микрофона
- **НО** при использовании `chromeMediaSource: 'tab'` обычно **НЕ показывается**, потому что:
  - Это не реальный микрофон
  - Это захват аудио с вкладки
  - Chrome понимает, что это внутренний источник

**Важно:** Это зависит от настроек браузера и политик безопасности.

## Текущий поток в вашем коде

```
1. Пользователь нажимает "Start Recording" в popup
   ↓
2. Popup вызывает chrome.tabCapture.getMediaStreamId()
   → ❌ НЕТ запроса разрешения (уже есть в manifest)
   ↓
3. Получаем streamId
   ↓
4. Передаем streamId в offscreen document
   ↓
5. Offscreen вызывает getUserMedia() с chromeMediaSource
   → ⚠️ МОЖЕТ показаться диалог (но обычно НЕТ)
   ↓
6. Захват начинается
```

## Как проверить, запросит ли браузер разрешение

### Вариант 1: Проверить в настройках расширения
1. Откройте `chrome://extensions/`
2. Найдите ваше расширение
3. Проверьте раздел "Разрешения"
4. Если видите "Захват содержимого вкладок" - разрешение уже есть

### Вариант 2: Удалить и переустановить
1. Удалите расширение
2. Переустановите
3. При установке Chrome покажет диалог с разрешениями

## Если нужно, чтобы разрешение запрашивалось каждый раз

Если вы хотите, чтобы пользователь каждый раз подтверждал захват:

1. **Уберите** `"tabCapture"` из `permissions` в manifest
2. Используйте **optional permissions**:
   ```json
   {
     "permissions": ["activeTab", "offscreen", "alarms"],
     "optional_permissions": ["tabCapture"]
   }
   ```
3. Запрашивайте разрешение программно:
   ```typescript
   await chrome.permissions.request({ permissions: ['tabCapture'] });
   ```

## Рекомендация

**Оставьте как есть** - разрешение в manifest:
- ✅ Пользователь видит разрешения при установке (прозрачно)
- ✅ Не нужно запрашивать каждый раз
- ✅ Лучший UX для пользователя
- ✅ Захват работает сразу после установки

## Итог

**В вашем случае:**
- Разрешение запрашивается **ОДИН РАЗ** при установке расширения
- При нажатии "Start Recording" **НЕТ** дополнительных запросов
- `getUserMedia()` обычно **НЕ показывает** диалог, так как используется `chromeMediaSource: 'tab'`

